# 🌟 Telegram Stars 支付流程圖

## 📋 系統架構概覽

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Telegram Bot  │    │   Express API   │    │   Mini App      │
│   (Node.js)     │    │   (Port 3001)   │    │   (Frontend)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │   Stripe API    │
                    │   (Provider)    │
                    └─────────────────┘
```

## 🔄 完整支付流程

### 1. 🚀 初始化階段
```
┌─────────────────────────────────────────────────────────────┐
│                    系統初始化                               │
├─────────────────────────────────────────────────────────────┤
│ 1. 載入環境變數 (.env)                                      │
│ 2. 初始化 Telegram Bot                                      │
│ 3. 設定 Express 服務器 (Port 3001)                         │
│ 4. 載入商品資料                                             │
│ 5. 設定支付模式 (模擬/測試/正式)                            │
└─────────────────────────────────────────────────────────────┘
```

### 2. 🛒 用戶購買流程 (Mini App)

```
┌─────────────────────────────────────────────────────────────┐
│                    Mini App 購買流程                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐                                            │
│  │ 用戶點擊    │                                            │
│  │ 購買按鈕    │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 取得用戶 ID │                                            │
│  │ (initData)  │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 呼叫 API    │                                            │
│  │ /api/create-│                                            │
│  │ invoice     │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 接收        │                                            │
│  │ invoice URL │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 開啟        │                                            │
│  │ 支付視窗    │                                            │
│  │ (openInvoice)│                                           │
│  └─────────────┘                                            │
└─────────────────────────────────────────────────────────────┘
```

### 3. 🔧 後端 API 處理流程

```
┌─────────────────────────────────────────────────────────────┐
│                    API 處理流程                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐                                            │
│  │ 接收請求    │                                            │
│  │ POST /api/  │                                            │
│  │ create-invoice│                                          │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 驗證商品    │                                            │
│  │ 是否存在    │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 呼叫        │                                            │
│  │ bot.create- │                                            │
│  │ InvoiceLink │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 回傳        │                                            │
│  │ invoice URL │                                            │
│  └─────────────┘                                            │
└─────────────────────────────────────────────────────────────┘
```

### 4. 💳 Telegram 支付處理流程

```
┌─────────────────────────────────────────────────────────────┐
│                Telegram 支付處理流程                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐                                            │
│  │ 用戶在      │                                            │
│  │ Mini App    │                                            │
│  │ 內點擊支付  │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ Telegram    │                                            │
│  │ 顯示支付    │                                            │
│  │ 確認視窗    │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 觸發        │                                            │
│  │ pre_checkout│                                            │
│  │ _query      │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 驗證訂單    │                                            │
│  │ (金額/商品) │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 用戶確認    │                                            │
│  │ 支付        │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 觸發        │                                            │
│  │ successful_ │                                            │
│  │ payment     │                                            │
│  └─────────────┘                                            │
└─────────────────────────────────────────────────────────────┘
```

### 5. 🎯 支付成功處理流程

```
┌─────────────────────────────────────────────────────────────┐
│                  支付成功處理流程                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐                                            │
│  │ 接收        │                                            │
│  │ successful_ │                                            │
│  │ payment     │                                            │
│  │ 事件        │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 解析支付    │                                            │
│  │ 資訊        │                                            │
│  │ (金額/商品) │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 發送成功    │                                            │
│  │ 訊息給用戶  │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 記錄交易    │                                            │
│  │ 日誌        │                                            │
│  └─────────────┘                                            │
└─────────────────────────────────────────────────────────────┘
```

## 🔧 技術細節

### 支付模式
```
┌─────────────────┬─────────────────┬─────────────────┐
│   純模擬模式    │   測試支付模式   │   正式支付模式   │
│  SIMULATION_ONLY│  ENABLE_REAL_   │  ENABLE_REAL_   │
│  = true         │  PAYMENTS = true│  PAYMENTS = true│
│                 │  + 測試金鑰     │  + 正式金鑰     │
├─────────────────┼─────────────────┼─────────────────┤
│ • 無真實扣款    │ • 使用測試金鑰  │ • 真實扣款      │
│ • 模擬支付流程  │ • 無真實費用    │ • 產生真實費用  │
│ • 用於開發測試  │ • 用於測試環境  │ • 用於生產環境  │
└─────────────────┴─────────────────┴─────────────────┘
```

### API 端點
```
POST /api/create-invoice
├── 請求參數
│   ├── productId: 商品 ID
│   └── userId: 用戶 ID
└── 回應
    ├── success: 布林值
    ├── invoiceUrl: 支付連結
    ├── message: 訊息
    └── debug: 除錯資訊
```

### 商品結構
```typescript
interface Product {
  id: string;           // 商品 ID
  title: string;        // 商品標題
  description: string;  // 商品描述
  priceStars: number;   // Stars 價格
  photoUrl?: string;    // 商品圖片
  secretContent: string; // 購買後內容
}
```

## 🚀 部署架構

```
┌─────────────────────────────────────────────────────────────┐
│                    部署架構                                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │   Telegram  │    │   Express   │    │   Stripe    │     │
│  │   Bot       │◄──►│   Server    │◄──►│   API       │     │
│  │   (Polling) │    │   (Port 3001)│    │   (Provider)│     │
│  └─────────────┘    └─────────────┘    └─────────────┘     │
│         │                   │                   │           │
│         │                   │                   │           │
│         ▼                   ▼                   ▼           │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │   Mini App  │    │   Static    │    │   Payment   │     │
│  │   (Frontend)│    │   Files     │    │   Processing│     │
│  └─────────────┘    └─────────────┘    └─────────────┘     │
└─────────────────────────────────────────────────────────────┘
```

## 📊 流程總結

1. **用戶在 Mini App 中點擊購買**
2. **前端呼叫後端 API 建立 invoice**
3. **後端使用 Telegram Bot API 建立支付連結**
4. **前端在 Mini App 內開啟支付視窗**
5. **用戶完成支付**
6. **Telegram 觸發支付成功事件**
7. **Bot 發送成功訊息並記錄交易**

這個流程確保用戶可以在 Mini App 內完成整個支付過程，無需跳轉到其他頁面。