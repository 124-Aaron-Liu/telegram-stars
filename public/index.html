<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Stars å•†åº—</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      .tg-btn {
        display: inline-block;
        padding: 12px 32px;
        background-color: #229ED9;
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        font-weight: bold;
        text-decoration: none;
        box-shadow: 0 2px 8px rgba(34,158,217,0.15);
        transition: background 0.2s;
        cursor: pointer;
      }
      .tg-btn:hover {
        background-color: #176ca6;
      }
      .product-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin: 20px 0;
      }
    </style>
</head>
<body>
  <div class="product-list">
    <button class="tg-btn" onclick="buyProduct('gold_100')">ğŸ›’ è³¼è²· 10 é‡‘å¹£</button>
    <button class="tg-btn" onclick="buyProduct('gold_200')">ğŸ›’ è³¼è²· 20 é‡‘å¹£</button>
    <button class="tg-btn" onclick="buyProduct('gold_500')">ğŸ›’ è³¼è²· 50 é‡‘å¹£</button>
  </div>

  <script>
    // å–å¾— Telegram WebApp ç‰©ä»¶
    const tg = window.Telegram.WebApp;

    // åˆå§‹åŒ– WebApp
    tg.ready();

    async function buyProduct(productId) {
      try {
        alert('ğŸ›’ ç”¨æˆ¶é»æ“Šè³¼è²·æŒ‰éˆ•:', productId);

        // æª¢æŸ¥ WebApp æ˜¯å¦å¯ç”¨
        if (!window.Telegram?.WebApp) {
          alert('âŒ ç„¡æ³•è¼‰å…¥ Telegram WebApp');
          return;
        }

        // å–å¾—ç”¨æˆ¶ ID
        let userId = window.Telegram.WebApp.initDataUnsafe?.user?.id;
        if (!userId) {
          alert('âš ï¸ ç„¡æ³•å–å¾—ç”¨æˆ¶ IDï¼Œä½¿ç”¨æ¸¬è©¦ç”¨æˆ¶ ID');
          userId = 5000651398; // ä½ çš„æ¸¬è©¦ç”¨æˆ¶ ID
        }

        alert(`ğŸ‘¤ ç”¨æˆ¶ ID: ${userId}`);

        // 1. Mini App å‰ç«¯å‘¼å«å¾Œç«¯ API
        alert('ğŸŒ å‘¼å«å¾Œç«¯ API...');

        const res = await fetch('/api/create-invoice', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            productId: productId,
            userId: userId
          })
        });

        alert('ğŸ“¡ API å›æ‡‰ç‹€æ…‹:', res.status);

        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`API éŒ¯èª¤: ${res.status} - ${errorText}`);
        }

        const data = await res.json();
        alert('ğŸ“„ æ”¶åˆ° API å›æ‡‰:', data);

        if (!data.success) {
          throw new Error(data.error || 'API å‘¼å«å¤±æ•—');
        }

        // 2. Mini App å‰ç«¯æ¥æ”¶ invoiceUrl
        const invoiceUrl = data.invoiceUrl;
        alert('ğŸ”— æ”¶åˆ° invoice URL:', invoiceUrl);

        // 3. Mini App å‘¼å« Telegram.WebApp.openInvoice
        if (typeof window.Telegram.WebApp.openInvoice === 'function') {
          alert('ğŸ’³ é–‹å•Ÿæ”¯ä»˜è¦–çª—...');
          window.Telegram.WebApp.openInvoice(invoiceUrl, (status) => {
            alert(`ğŸ’³ æ”¯ä»˜ç‹€æ…‹: ${status}`);

            if (status === 'paid') {
              alert('ğŸ‰ æ”¯ä»˜æˆåŠŸï¼æ‚¨çš„å•†å“å·²æº–å‚™å°±ç·’');
              // é€™è£¡å¯ä»¥æ›´æ–° UI æˆ–ç™¼é€æˆåŠŸè¨Šæ¯
            } else if (status === 'cancelled') {
              alert('âŒ å·²å–æ¶ˆæ”¯ä»˜');
            } else {
              alert('âŒ æ”¯ä»˜å¤±æ•—ï¼Œè«‹é‡è©¦');
            }
          });
        } else {
          alert('âš ï¸ openInvoice ä¸å¯ç”¨ï¼Œä½¿ç”¨å‚™ç”¨æ–¹æ¡ˆ');
          // å‚™ç”¨æ–¹æ¡ˆï¼šç›´æ¥è·³è½‰åˆ° invoice URL
          if (window.Telegram.WebApp.openTelegramLink) {
            window.Telegram.WebApp.openTelegramLink(invoiceUrl);
          } else {
            window.open(invoiceUrl, '_blank');
          }
        }

      } catch (error) {
        alert.error('âŒ éŒ¯èª¤:', error);
        alert(`éŒ¯èª¤: ${error.message}`);
      }
    }
  </script>
</body>
</html>