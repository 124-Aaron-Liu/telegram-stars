# 🌟 Mini App 前後端觸發邏輯流程圖

## 📋 系統架構

```
┌─────────────────────────────────────────────────────────────┐
│                    Mini App 支付系統                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │   Mini App  │    │   Express   │    │   Telegram  │     │
│  │   Frontend  │◄──►│   Backend   │◄──►│   Bot API   │     │
│  │   (Port 3001)│    │   (Port 3001)│    │   (Polling) │     │
│  └─────────────┘    └─────────────┘    └─────────────┘     │
│         │                   │                   │           │
│         │                   │                   │           │
│         ▼                   ▼                   ▼           │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │ Telegram    │    │ Payment     │    │ Payment     │     │
│  │ WebApp API  │    │ Processing  │    │ Events      │     │
│  └─────────────┘    └─────────────┘    └─────────────┘     │
└─────────────────────────────────────────────────────────────┘
```

## 🔄 詳細觸發流程

### 1. 🚀 系統初始化

```
┌─────────────────────────────────────────────────────────────┐
│                    系統初始化流程                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐                                            │
│  │ 1. 載入環境 │                                            │
│  │    變數     │                                            │
│  │    (.env)   │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 2. 初始化   │                                            │
│  │ Telegram Bot│                                            │
│  │ (Polling)   │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 3. 啟動     │                                            │
│  │ Express     │                                            │
│  │ Server      │                                            │
│  │ (Port 3001) │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 4. 載入     │                                            │
│  │ 商品資料    │                                            │
│  └─────────────┘                                            │
└─────────────────────────────────────────────────────────────┘
```

### 2. 🛒 用戶操作觸發流程

```
┌─────────────────────────────────────────────────────────────┐
│                  用戶操作觸發流程                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐                                            │
│  │ 用戶在      │                                            │
│  │ Mini App    │                                            │
│  │ 中點擊      │                                            │
│  │ 購買按鈕    │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 觸發        │                                            │
│  │ buyProduct()│                                            │
│  │ 函數        │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 檢查        │                                            │
│  │ Telegram    │                                            │
│  │ WebApp      │                                            │
│  │ 是否可用    │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 取得        │                                            │
│  │ 用戶 ID     │                                            │
│  │ (initData)  │                                            │
│  └─────────────┘                                            │
└─────────────────────────────────────────────────────────────┘
```

### 3. 🔧 前端 API 呼叫流程

```
┌─────────────────────────────────────────────────────────────┐
│                  前端 API 呼叫流程                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐                                            │
│  │ 前端呼叫    │                                            │
│  │ fetch()     │                                            │
│  │ POST /api/  │                                            │
│  │ create-invoice│                                          │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 發送請求    │                                            │
│  │ 參數：      │                                            │
│  │ - productId │                                            │
│  │ - userId    │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 等待        │                                            │
│  │ 後端回應    │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 接收        │                                            │
│  │ JSON 回應   │                                            │
│  └─────────────┘                                            │
└─────────────────────────────────────────────────────────────┘
```

### 4. 🔧 後端 API 處理流程

```
┌─────────────────────────────────────────────────────────────┐
│                  後端 API 處理流程                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐                                            │
│  │ 接收        │                                            │
│  │ POST 請求   │                                            │
│  │ /api/create-│                                            │
│  │ invoice     │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 解析        │                                            │
│  │ 請求參數    │                                            │
│  │ - productId │                                            │
│  │ - userId    │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 查找        │                                            │
│  │ 商品資料    │                                            │
│  │ (products)  │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 呼叫        │                                            │
│  │ bot.create- │                                            │
│  │ InvoiceLink │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 回傳        │                                            │
│  │ JSON 回應   │                                            │
│  │ - success   │                                            │
│  │ - invoiceUrl│                                            │
│  └─────────────┘                                            │
└─────────────────────────────────────────────────────────────┘
```

### 5. 💳 Telegram 支付觸發流程

```
┌─────────────────────────────────────────────────────────────┐
│                Telegram 支付觸發流程                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐                                            │
│  │ 前端接收    │                                            │
│  │ invoice URL │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 呼叫        │                                            │
│  │ Telegram    │                                            │
│  │ WebApp      │                                            │
│  │ openInvoice │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ Telegram    │                                            │
│  │ 顯示        │                                            │
│  │ 支付視窗    │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 用戶        │                                            │
│  │ 完成支付    │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 觸發        │                                            │
│  │ 回調函數    │                                            │
│  │ (status)    │                                            │
│  └─────────────┘                                            │
└─────────────────────────────────────────────────────────────┘
```

### 6. 🎯 Bot 事件處理流程

```
┌─────────────────────────────────────────────────────────────┐
│                  Bot 事件處理流程                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐                                            │
│  │ Telegram    │                                            │
│  │ 觸發        │                                            │
│  │ pre_checkout│                                            │
│  │ _query      │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ Bot 驗證    │                                            │
│  │ 訂單        │                                            │
│  │ (金額/商品) │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 回覆        │                                            │
│  │ 驗證結果    │                                            │
│  │ (true/false)│                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ 支付完成    │                                            │
│  │ 後觸發      │                                            │
│  │ successful_ │                                            │
│  │ payment     │                                            │
│  └─────┬───────┘                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌─────────────┐                                            │
│  │ Bot 發送    │                                            │
│  │ 成功訊息    │                                            │
│  │ 給用戶      │                                            │
│  └─────────────┘                                            │
└─────────────────────────────────────────────────────────────┘
```

## 🔧 技術實現細節

### 前端觸發邏輯
```javascript
// 1. 用戶點擊觸發
onclick="buyProduct('gold_100')"

// 2. 函數執行流程
async function buyProduct(productId) {
  // 2.1 檢查 WebApp 可用性
  if (!window.Telegram?.WebApp) return;

  // 2.2 取得用戶 ID
  let userId = window.Telegram.WebApp.initDataUnsafe?.user?.id;

  // 2.3 呼叫後端 API
  const res = await fetch('/api/create-invoice', {
    method: 'POST',
    body: JSON.stringify({ productId, userId })
  });

  // 2.4 處理回應
  const data = await res.json();

  // 2.5 開啟支付視窗
  window.Telegram.WebApp.openInvoice(data.invoiceUrl, (status) => {
    // 處理支付結果
  });
}
```

### 後端觸發邏輯
```typescript
// 1. API 路由處理
app.post("/api/create-invoice", async (req, res) => {
  const { productId, userId } = req.body;

  // 2. 查找商品
  const product = products.find((p) => p.id === productId);

  // 3. 建立 Invoice Link (透過 Telegram Bot API)
  const invoiceUrl = await bot.createInvoiceLink(
    product.title,
    product.description,
    product.id,
    stripePublishableKeyTest, // 僅作為 provider token 傳遞
    "XTR",
    [{ label: product.title, amount: product.priceStars }],
    { /* 選項 */ }
  );

  // 4. 回傳結果
  res.json({ success: true, invoiceUrl });
});

// 5. Bot 事件監聽
bot.on("pre_checkout_query", async (query) => {
  // 驗證訂單
  await bot.answerPreCheckoutQuery(query.id, true);
});

bot.on("successful_payment", async (msg) => {
  // 處理支付成功
  await bot.sendMessage(chatId, "支付成功！");
});
```

## 📊 觸發順序總結

1. **用戶操作** → 點擊購買按鈕
2. **前端觸發** → `buyProduct()` 函數執行
3. **API 呼叫** → `fetch('/api/create-invoice')`
4. **後端處理** → 透過 Telegram Bot API 建立 Invoice Link
5. **前端接收** → 取得 invoice URL
6. **支付觸發** → `openInvoice()` 開啟支付
7. **Bot 事件** → `pre_checkout_query` → `successful_payment`
8. **完成處理** → 發送成功訊息

這個流程確保了從用戶操作到支付完成的完整觸發鏈路，同時避免了直接整合 Stripe API 的複雜性！